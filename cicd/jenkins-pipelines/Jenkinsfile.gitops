pipeline {
  agent any

  // ç§»é™¤å‚æ•°åŒ–æ„å»ºï¼Œæ”¹ä¸ºè‡ªåŠ¨æ£€æµ‹
  // parameters {
  //   choice(name: 'ENV', choices: ['dev', 'test', 'prod'], description: 'Target environment')
  //   choice(name: 'ACTION', choices: ['plan', 'apply', 'destroy'], description: 'Terraform action')
  //   booleanParam(name: 'AUTO_APPROVE', defaultValue: true, description: 'Auto-approve (prod å»ºè®®æ‰‹åŠ¨)')
  // }

  environment {
    TF_IN_AUTOMATION = '1'
    AWS_REGION       = 'ap-southeast-2'
    GITHUB_REPO      = 'yyfyyfstudy1/infra-modules'
  }

  options {
    timestamps()
    buildDiscarder(logRotator(numToKeepStr: '10'))
    // é˜²æ­¢å¹¶å‘æ„å»º
    disableConcurrentBuilds()
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Detect Action & Environment') {
      steps {
        script {
          // è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒï¼ˆåŸºäºåˆ†æ”¯æˆ–PRï¼‰
          if (env.CHANGE_ID) {
            // PR æ„å»º
            env.TARGET_ENV = 'dev'  // PR é»˜è®¤åœ¨ dev ç¯å¢ƒæµ‹è¯•
            env.IS_PR_BUILD = 'true'
            
            // æ£€æµ‹ PR çŠ¶æ€
            if (env.CHANGE_TARGET == 'main') {
              if (isPRMerged()) {
                env.TERRAFORM_ACTION = 'apply'
                echo "ğŸ¯ æ£€æµ‹åˆ° PR å·²åˆå¹¶ï¼Œæ‰§è¡Œ terraform apply"
              } else {
                env.TERRAFORM_ACTION = 'plan'
                echo "ğŸ¯ æ£€æµ‹åˆ° PR æ„å»ºï¼Œæ‰§è¡Œ terraform plan"
              }
            } else {
              env.TERRAFORM_ACTION = 'plan'
              echo "ğŸ¯ æ£€æµ‹åˆ° PR æ„å»ºï¼ˆé main åˆ†æ”¯ï¼‰ï¼Œæ‰§è¡Œ terraform plan"
            }
          } else {
            // ç›´æ¥æ¨é€æ„å»ºï¼ˆé PRï¼‰
            env.IS_PR_BUILD = 'false'
            // å½“ Jenkins æœªæä¾› BRANCH_NAME æ—¶ï¼Œä¸»åŠ¨åˆ¤æ–­æ˜¯å¦åœ¨ main ä¸Šï¼ŒåŠæ˜¯å¦ä¸ºåˆå¹¶æäº¤
            def onMain = isCommitOnMain()
            def mergedPR = isMergeCommitToMain()

            if (mergedPR || onMain) {
              // åˆå¹¶åˆ° main åï¼Œé»˜è®¤å¯¹ dev ç¯å¢ƒæ‰§è¡Œ applyï¼ˆå†ç”±äººå·¥æ¨è¿›åˆ° test/prodï¼‰
              env.TARGET_ENV = 'dev'
              env.TERRAFORM_ACTION = 'apply'
              echo "ğŸ¯ æ£€æµ‹åˆ°åˆå¹¶åˆ° mainï¼Œæ‰§è¡Œ terraform apply åˆ° dev"
            } else {
              env.TARGET_ENV = 'dev'
              env.TERRAFORM_ACTION = 'plan'
              echo "ğŸ¯ æ£€æµ‹åˆ°åˆ†æ”¯æ¨é€ï¼Œæ‰§è¡Œ terraform plan åˆ° dev"
            }
          }
          
          echo "ğŸ“‹ è‡ªåŠ¨æ£€æµ‹ç»“æœï¼š"
          echo "   - ç¯å¢ƒ: ${env.TARGET_ENV}"
          echo "   - æ“ä½œ: ${env.TERRAFORM_ACTION}"
          echo "   - æ˜¯å¦ PR: ${env.IS_PR_BUILD}"
          echo "   - åˆ†æ”¯: ${env.BRANCH_NAME ?: 'N/A'}"
          echo "   - æäº¤: ${env.GIT_COMMIT?.take(7) ?: 'unknown'}"
          
          if (env.CHANGE_ID) {
            echo "   - PR ID: #${env.CHANGE_ID}"
            echo "   - PR æ ‡é¢˜: ${env.CHANGE_TITLE ?: 'N/A'}"
            echo "   - æºåˆ†æ”¯: ${env.CHANGE_BRANCH ?: 'N/A'}"
            echo "   - ç›®æ ‡åˆ†æ”¯: ${env.CHANGE_TARGET ?: 'N/A'}"
          }
        }
      }
    }

    stage('Terraform Operations') {
      when {
        expression { env.IS_PR_BUILD == 'true' }
      }
      steps {
        script {
          def credId = (env.TARGET_ENV == 'dev')  ? 'aws-role-dev'  :
                       (env.TARGET_ENV == 'test') ? 'aws-role-test' :
                                                     'aws-role-prod'

          withCredentials([string(credentialsId: credId, variable: 'ROLE_ARN')]) {
            withAWS(region: AWS_REGION, role: ROLE_ARN, roleSessionName: "jenkins-${env.TARGET_ENV}") {

              dir("infra/envs/${env.TARGET_ENV}") {
                if (env.TERRAFORM_ACTION == 'plan') {
                  echo "ğŸ” æ‰§è¡Œ Terraform Plan..."
                  sh """
                    terraform init -backend-config=backend.hcl -reconfigure
                    terraform plan -var-file=${env.TARGET_ENV}.tfvars -out=tfplan
                    terraform show -no-color tfplan > plan.txt
                    terraform show -json tfplan > plan.json
                  """
                  
                  // å¦‚æœæ˜¯ PRï¼Œè‡ªåŠ¨è¯„è®ºåˆ° GitHub
                  script {
                    if (env.IS_PR_BUILD == 'true') {
                      commentPlanToPR()
                    }
                  }
                  
                  echo "âœ… Plan å®Œæˆï¼"
                  if (env.IS_PR_BUILD == 'true') {
                    echo "ğŸ“ è®¡åˆ’ç»“æœå·²è¯„è®ºåˆ° PR #${env.CHANGE_ID}"
                  }
                  
                } else if (env.TERRAFORM_ACTION == 'apply') {
                  echo "ğŸš€ æ‰§è¡Œ Terraform Apply..."
                  
                  // å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œéœ€è¦é¢å¤–ç¡®è®¤
                  if (env.TARGET_ENV == 'prod') {
                    input message: "ç¡®è®¤ Apply åˆ°ç”Ÿäº§ç¯å¢ƒ ${env.TARGET_ENV}ï¼Ÿ", ok: 'ç¡®è®¤ Apply'
                  }
                  
                  sh """
                    terraform init -backend-config=backend.hcl -reconfigure
                    terraform plan -var-file=${env.TARGET_ENV}.tfvars -out=tfplan
                  """
                  
                  sh "terraform apply -auto-approve tfplan"
                  
                  // å¦‚æœæ˜¯ PRï¼Œè¯„è®ºåº”ç”¨ç»“æœ
                  script {
                    if (env.IS_PR_BUILD == 'true') {
                      commentApplyToPR()
                    }
                  }
                  
                  echo "âœ… Apply å®Œæˆï¼èµ„æºå·²åˆ›å»º/æ›´æ–°åˆ° ${env.TARGET_ENV} ç¯å¢ƒ"
                  
                } else if (env.TERRAFORM_ACTION == 'destroy') {
                  echo "âš ï¸  æ‰§è¡Œ Terraform Destroy..."
                  if (env.TARGET_ENV == 'prod') {
                    input message: "ç¡®è®¤ DESTROY ç”Ÿäº§ç¯å¢ƒï¼Ÿ", ok: 'YES, destroy'
                  }
                  
                  sh """
                    terraform init -backend-config=backend.hcl -reconfigure
                    terraform destroy -auto-approve -var-file=${env.TARGET_ENV}.tfvars
                  """
                  
                  // å¦‚æœæ˜¯ PRï¼Œè¯„è®ºé”€æ¯ç»“æœ
                  script {
                    if (env.IS_PR_BUILD == 'true') {
                      commentDestroyToPR()
                    }
                  }
                  
                  echo "âœ… Destroy å®Œæˆï¼èµ„æºå·²ä» ${env.TARGET_ENV} ç¯å¢ƒåˆ é™¤"
                }
              }
            }
          }
        }
      }
    }

    // Deploy DEV (auto) - åœ¨ PR åˆå¹¶åˆ° main åè‡ªåŠ¨æ‰§è¡Œ
    stage('Deploy DEV (auto)') {
      when {
        expression { env.IS_PR_BUILD == 'false' && (isMergeCommitToMain() || isCommitOnMain()) }
      }
      steps {
        script {
          echo "ğŸš€ éƒ¨ç½²åˆ° DEV ç¯å¢ƒï¼ˆè‡ªåŠ¨ï¼‰"
          def credId = 'aws-role-dev'
          withCredentials([string(credentialsId: credId, variable: 'ROLE_ARN')]) {
            withAWS(region: AWS_REGION, role: ROLE_ARN, roleSessionName: "jenkins-dev") {
              dir("infra/envs/dev") {
                sh """
                  terraform init -backend-config=backend.hcl -reconfigure
                  terraform plan -var-file=dev.tfvars -out=tfplan
                """
                sh "terraform apply -auto-approve tfplan"
              }
            }
          }
          echo "âœ… DEV ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
        }
      }
    }

    // Promote to TEST (manual gate)
    stage('Promote to TEST (manual gate)') {
      when {
        expression { env.IS_PR_BUILD == 'false' && (isMergeCommitToMain() || isCommitOnMain()) }
      }
      steps {
        script {
          input message: 'Promote åˆ° TEST ç¯å¢ƒï¼Ÿ', ok: 'Promote'
          echo "ğŸš€ éƒ¨ç½²åˆ° TEST ç¯å¢ƒ"
          def credId = 'aws-role-test'
          withCredentials([string(credentialsId: credId, variable: 'ROLE_ARN')]) {
            withAWS(region: AWS_REGION, role: ROLE_ARN, roleSessionName: "jenkins-test") {
              dir("infra/envs/test") {
                sh """
                  terraform init -backend-config=backend.hcl -reconfigure
                  terraform plan -var-file=test.tfvars -out=tfplan
                """
                sh "terraform apply -auto-approve tfplan"
              }
            }
          }
          echo "âœ… TEST ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
        }
      }
    }

    // Promote to PROD (manual gate)
    stage('Promote to PROD (manual gate)') {
      when {
        expression { env.IS_PR_BUILD == 'false' && (isMergeCommitToMain() || isCommitOnMain()) }
      }
      steps {
        script {
          input message: 'Promote åˆ° PROD ç¯å¢ƒï¼Ÿï¼ˆè¯·å†æ¬¡ç¡®è®¤ï¼‰', ok: 'Promote to PROD'
          echo "ğŸš€ éƒ¨ç½²åˆ° PROD ç¯å¢ƒ"
          def credId = 'aws-role-prod'
          withCredentials([string(credentialsId: credId, variable: 'ROLE_ARN')]) {
            withAWS(region: AWS_REGION, role: ROLE_ARN, roleSessionName: "jenkins-prod") {
              dir("infra/envs/prod") {
                sh """
                  terraform init -backend-config=backend.hcl -reconfigure
                  terraform plan -var-file=prod.tfvars -out=tfplan
                """
                // ç»è¿‡ä¸Šé¢çš„äººå·¥ç¡®è®¤ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ auto-approve
                sh "terraform apply -auto-approve tfplan"
              }
            }
          }
          echo "âœ… PROD ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
        }
      }
    }
  }

  post {
    always {
      // å½’æ¡£æ„å»ºäº§ç‰©
      archiveArtifacts artifacts: '**/tfplan, **/plan.txt, **/plan.json', allowEmptyArchive: true
      // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      sh 'rm -f infra/envs/*/tfplan infra/envs/*/plan.txt infra/envs/*/plan.json || true'
    }
    success {
      echo "ğŸ‰ Pipeline æ‰§è¡ŒæˆåŠŸï¼"
    }
    failure {
      echo "âŒ Pipeline æ‰§è¡Œå¤±è´¥ï¼"
      // å¦‚æœæ˜¯ PRï¼Œè¯„è®ºå¤±è´¥ä¿¡æ¯
      script {
        if (env.IS_PR_BUILD == 'true') {
          commentFailureToPR()
        }
      }
    }
  }
}

// æ£€æŸ¥ PR æ˜¯å¦å·²åˆå¹¶
def isPRMerged() {
  try {
    // æ£€æŸ¥å½“å‰æäº¤æ˜¯å¦åœ¨ç›®æ ‡åˆ†æ”¯ä¸Š
    def result = sh(
      script: "git log --oneline -n 10 --grep='Merge pull request #${env.CHANGE_ID}' || echo 'not_merged'",
      returnStdout: true
    ).trim()
    
    return !result.contains('not_merged')
  } catch (Exception e) {
    echo "âš ï¸ æ£€æŸ¥ PR åˆå¹¶çŠ¶æ€å¤±è´¥: ${e.getMessage()}"
    return false
  }
}

// é PR æ„å»ºï¼šåˆ¤æ–­å½“å‰æäº¤æ˜¯å¦åœ¨ origin/main ä¸Š
def isCommitOnMain() {
  try {
    def status = sh(
      script: '''git branch -r --contains HEAD | grep -E 'origin/main$' >/dev/null 2>&1; echo $?''',
      returnStdout: true
    ).trim()
    return status == '0'
  } catch (Exception e) {
    echo "âš ï¸ æ£€æŸ¥æ˜¯å¦åœ¨ main åˆ†æ”¯å¤±è´¥: ${e.getMessage()}"
    return false
  }
}

// é PR æ„å»ºï¼šåˆ¤æ–­æœ€è¿‘ä¸€æ¬¡æäº¤æ˜¯å¦ä¸ºåˆå¹¶ PR çš„æäº¤
def isMergeCommitToMain() {
  try {
    def message = sh(
      script: 'git log -1 --pretty=%B',
      returnStdout: true
    ).trim()
    // å…¸å‹åˆå¹¶ä¿¡æ¯ï¼šMerge pull request #<id> from <branch>
    return message.startsWith('Merge pull request #')
  } catch (Exception e) {
    echo "âš ï¸ æ£€æŸ¥æ˜¯å¦ä¸ºåˆå¹¶æäº¤å¤±è´¥: ${e.getMessage()}"
    return false
  }
}

// è¯„è®º Plan ç»“æœåˆ° PR
def commentPlanToPR() {
  try {
    def planContent = readFile("infra/envs/${env.TARGET_ENV}/plan.txt").trim()
    def comment = """
## ğŸ” Terraform Plan - ${env.TARGET_ENV.toUpperCase()} Environment

**æ„å»ºä¿¡æ¯ï¼š**
- ç¯å¢ƒ: `${env.TARGET_ENV}`
- åˆ†æ”¯: `${env.BRANCH_NAME ?: 'main'}`
- æäº¤: `${env.GIT_COMMIT?.take(7) ?: 'unknown'}`
- æ„å»º: [#${env.BUILD_NUMBER}](${env.BUILD_URL})

**è®¡åˆ’æ‘˜è¦ï¼š**
```
${planContent}
```

**ä¸‹ä¸€æ­¥ï¼š**
- âœ… å¦‚æœè®¡åˆ’æ­£ç¡®ï¼Œè¯·åˆå¹¶æ­¤ PR
- ğŸ”„ åˆå¹¶åå°†è‡ªåŠ¨è§¦å‘ terraform apply åˆ° ${env.TARGET_ENV} ç¯å¢ƒ
- âŒ å¦‚æœ‰é—®é¢˜ï¼Œè¯·ä¿®æ”¹ä»£ç åé‡æ–°æäº¤

---
*æ­¤è¯„è®ºç”± Jenkins è‡ªåŠ¨ç”Ÿæˆ*
"""
    
    postCommentToPR(comment)
    echo "ğŸ“ Plan ç»“æœå·²è¯„è®ºåˆ° PR #${env.CHANGE_ID}"
  } catch (Exception e) {
    echo "âš ï¸ è¯„è®º PR å¤±è´¥: ${e.getMessage()}"
  }
}

// è¯„è®º Apply ç»“æœåˆ° PR
def commentApplyToPR() {
  try {
    def comment = """
## âœ… Terraform Apply å®Œæˆ - ${env.TARGET_ENV.toUpperCase()} Environment

**æ„å»ºä¿¡æ¯ï¼š**
- ç¯å¢ƒ: `${env.TARGET_ENV}`
- åˆ†æ”¯: `${env.BRANCH_NAME ?: 'main'}`
- æäº¤: `${env.GIT_COMMIT?.take(7) ?: 'unknown'}`
- æ„å»º: [#${env.BUILD_NUMBER}](${env.BUILD_URL})

**æ‰§è¡Œç»“æœï¼š**
ğŸ‰ èµ„æºå·²æˆåŠŸåˆ›å»º/æ›´æ–°åˆ° ${env.TARGET_ENV} ç¯å¢ƒ

---
*æ­¤è¯„è®ºç”± Jenkins è‡ªåŠ¨ç”Ÿæˆ*
"""
    
    postCommentToPR(comment)
    echo "ğŸ“ Apply ç»“æœå·²è¯„è®ºåˆ° PR #${env.CHANGE_ID}"
  } catch (Exception e) {
    echo "âš ï¸ è¯„è®º PR å¤±è´¥: ${e.getMessage()}"
  }
}

// è¯„è®º Destroy ç»“æœåˆ° PR
def commentDestroyToPR() {
  try {
    def comment = """
## âš ï¸ Terraform Destroy å®Œæˆ - ${env.TARGET_ENV.toUpperCase()} Environment

**æ„å»ºä¿¡æ¯ï¼š**
- ç¯å¢ƒ: `${env.TARGET_ENV}`
- åˆ†æ”¯: `${env.BRANCH_NAME ?: 'main'}`
- æäº¤: `${env.GIT_COMMIT?.take(7) ?: 'unknown'}`
- æ„å»º: [#${env.BUILD_NUMBER}](${env.BUILD_URL})

**æ‰§è¡Œç»“æœï¼š**
ğŸ—‘ï¸ èµ„æºå·²ä» ${env.TARGET_ENV} ç¯å¢ƒåˆ é™¤

---
*æ­¤è¯„è®ºç”± Jenkins è‡ªåŠ¨ç”Ÿæˆ*
"""
    
    postCommentToPR(comment)
    echo "ğŸ“ Destroy ç»“æœå·²è¯„è®ºåˆ° PR #${env.CHANGE_ID}"
  } catch (Exception e) {
    echo "âš ï¸ è¯„è®º PR å¤±è´¥: ${e.getMessage()}"
  }
}

// è¯„è®ºå¤±è´¥ä¿¡æ¯åˆ° PR
def commentFailureToPR() {
  try {
    def comment = """
## âŒ Terraform Pipeline å¤±è´¥ - ${env.TARGET_ENV.toUpperCase()} Environment

**æ„å»ºä¿¡æ¯ï¼š**
- ç¯å¢ƒ: `${env.TARGET_ENV}`
- æ“ä½œ: `${env.TERRAFORM_ACTION}`
- åˆ†æ”¯: `${env.BRANCH_NAME ?: 'main'}`
- æäº¤: `${env.GIT_COMMIT?.take(7) ?: 'unknown'}`
- æ„å»º: [#${env.BUILD_NUMBER}](${env.BUILD_URL})

**é”™è¯¯ä¿¡æ¯ï¼š**
è¯·æŸ¥çœ‹ [æ„å»ºæ—¥å¿—](${env.BUILD_URL}) è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚

**å»ºè®®ï¼š**
- ğŸ” æ£€æŸ¥ Terraform é…ç½®è¯­æ³•
- ğŸ”§ ä¿®å¤é”™è¯¯åé‡æ–°æäº¤
- ğŸ“ å¦‚éœ€è¦å¸®åŠ©ï¼Œè¯·è”ç³» DevOps å›¢é˜Ÿ

---
*æ­¤è¯„è®ºç”± Jenkins è‡ªåŠ¨ç”Ÿæˆ*
"""
    
    postCommentToPR(comment)
    echo "ğŸ“ å¤±è´¥ä¿¡æ¯å·²è¯„è®ºåˆ° PR #${env.CHANGE_ID}"
  } catch (Exception e) {
    echo "âš ï¸ è¯„è®º PR å¤±è´¥: ${e.getMessage()}"
  }
}

// å‘é€è¯„è®ºåˆ° GitHub PR
def postCommentToPR(String comment) {
  withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
    def apiUrl = "https://api.github.com/repos/${env.GITHUB_REPO}/issues/${env.CHANGE_ID}/comments"
    def payload = [
      body: comment
    ]
    
    def response = httpRequest(
      httpMode: 'POST',
      url: apiUrl,
      headers: [
        'Authorization': "token ${GITHUB_TOKEN}",
        'Content-Type': 'application/json'
      ],
      requestBody: groovy.json.JsonBuilder(payload).toString()
    )
    
    if (response.status == 201) {
      echo "âœ… æˆåŠŸè¯„è®ºåˆ° PR #${env.CHANGE_ID}"
    } else {
      echo "âš ï¸ è¯„è®º PR å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}"
    }
  }
}

pipeline {
  agent any

  parameters {
    choice(name: 'ENV', choices: ['dev', 'test', 'prod'], description: 'Target environment')
    choice(name: 'ACTION', choices: ['plan', 'apply', 'destroy'], description: 'Terraform action')
    booleanParam(name: 'AUTO_APPROVE', defaultValue: true, description: 'Auto-approve (prod å»ºè®®æ‰‹åŠ¨)')
  }

  environment {
    TF_IN_AUTOMATION = '1'
    AWS_REGION       = 'ap-southeast-2'
    GITHUB_REPO      = 'yyfyyfstudy1/infra-modules'
  }

  options {
    timestamps()
    buildDiscarder(logRotator(numToKeepStr: '10'))
    // ä¿ç•™æ„å»ºäº§ç‰©
    archiveArtifacts artifacts: '**/tfplan, **/plan.txt, **/plan.json', allowEmptyArchive: true
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build Info') {
      steps {
        script {
          echo "ğŸš€ GitOps Terraform Pipeline å¯åŠ¨"
          echo "ğŸ“‹ æ„å»ºå‚æ•°ï¼š"
          echo "   - ç¯å¢ƒ: ${params.ENV}"
          echo "   - æ“ä½œ: ${params.ACTION}"
          echo "   - è‡ªåŠ¨æ‰¹å‡†: ${params.AUTO_APPROVE}"
          echo "   - åˆ†æ”¯: ${env.BRANCH_NAME ?: 'main'}"
          echo "   - æäº¤: ${env.GIT_COMMIT ?: 'unknown'}"
          echo ""
          
          // æ£€æµ‹æ˜¯å¦ä¸º PR æ„å»º
          if (env.CHANGE_ID) {
            echo "ğŸ” æ£€æµ‹åˆ° Pull Request: #${env.CHANGE_ID}"
            echo "   - PR æ ‡é¢˜: ${env.CHANGE_TITLE ?: 'N/A'}"
            echo "   - æºåˆ†æ”¯: ${env.CHANGE_BRANCH ?: 'N/A'}"
            echo "   - ç›®æ ‡åˆ†æ”¯: ${env.CHANGE_TARGET ?: 'N/A'}"
          } else {
            echo "ğŸ“ ç›´æ¥æ¨é€åˆ°åˆ†æ”¯: ${env.BRANCH_NAME ?: 'main'}"
          }
          
          echo "ğŸ’¡ æç¤ºï¼š"
          if (params.ACTION == 'plan') {
            echo "   - å½“å‰æ‰§è¡Œ PLANï¼ŒåªæŸ¥çœ‹å˜æ›´ï¼Œä¸ä¼šå®é™…åˆ›å»ºèµ„æº"
            if (env.CHANGE_ID) {
              echo "   - è®¡åˆ’ç»“æœå°†è‡ªåŠ¨è¯„è®ºåˆ° PR #${env.CHANGE_ID}"
            }
            echo "   - å¦‚éœ€åˆ›å»ºèµ„æºï¼Œè¯·é‡æ–°æ„å»ºå¹¶é€‰æ‹© ACTION=apply"
          } else if (params.ACTION == 'apply') {
            echo "   - å½“å‰æ‰§è¡Œ APPLYï¼Œå°†å®é™…åˆ›å»º/ä¿®æ”¹èµ„æº"
            echo "   - è¯·ç¡®è®¤è¿™æ˜¯ä½ æƒ³è¦çš„æ“ä½œ"
          } else if (params.ACTION == 'destroy') {
            echo "   - âš ï¸  å½“å‰æ‰§è¡Œ DESTROYï¼Œå°†åˆ é™¤èµ„æº"
            echo "   - è¯·ç¡®è®¤è¿™æ˜¯ä½ æƒ³è¦çš„æ“ä½œ"
          }
        }
      }
    }

    stage('Terraform Operations') {
      steps {
        script {
          def credId = (params.ENV == 'dev')  ? 'aws-role-dev'  :
                       (params.ENV == 'test') ? 'aws-role-test' :
                                                 'aws-role-prod'

          withCredentials([string(credentialsId: credId, variable: 'ROLE_ARN')]) {
            withAWS(region: AWS_REGION, role: ROLE_ARN, roleSessionName: "jenkins-${params.ENV}") {

              dir("infra/envs/${params.ENV}") {
                if (params.ACTION == 'plan') {
                  echo "ğŸ” æ‰§è¡Œ Terraform Plan..."
                  sh """
                    terraform init -backend-config=backend.hcl -reconfigure
                    terraform plan -var-file=${params.ENV}.tfvars -out=tfplan
                    terraform show -no-color tfplan > plan.txt
                    terraform show -json tfplan > plan.json
                  """
                  
                  // å¦‚æœæ˜¯ PRï¼Œè‡ªåŠ¨è¯„è®ºåˆ° GitHub
                  if (env.CHANGE_ID) {
                    commentPlanToPR()
                  }
                  
                  echo "âœ… Plan å®Œæˆï¼"
                  if (env.CHANGE_ID) {
                    echo "ğŸ“ è®¡åˆ’ç»“æœå·²è¯„è®ºåˆ° PR #${env.CHANGE_ID}"
                  }
                  echo "ğŸ’¡ å¦‚éœ€åº”ç”¨å˜æ›´ï¼Œè¯·é‡æ–°æ„å»ºå¹¶é€‰æ‹© ACTION=apply"
                  
                } else if (params.ACTION == 'apply') {
                  echo "ğŸš€ æ‰§è¡Œ Terraform Apply..."
                  sh """
                    terraform init -backend-config=backend.hcl -reconfigure
                    terraform plan -var-file=${params.ENV}.tfvars -out=tfplan
                  """
                  
                  if (!params.AUTO_APPROVE.toBoolean()) {
                    input message: "ç¡®è®¤ Apply åˆ° ${params.ENV} ?", ok: 'Apply'
                  }
                  
                  sh "terraform apply -auto-approve tfplan"
                  
                  // å¦‚æœæ˜¯ PRï¼Œè¯„è®ºåº”ç”¨ç»“æœ
                  if (env.CHANGE_ID) {
                    commentApplyToPR()
                  }
                  
                  echo "âœ… Apply å®Œæˆï¼èµ„æºå·²åˆ›å»º/æ›´æ–°"
                  
                } else if (params.ACTION == 'destroy') {
                  echo "âš ï¸  æ‰§è¡Œ Terraform Destroy..."
                  if (params.ENV == 'prod') {
                    input message: "ç¡®è®¤ DESTROY ç”Ÿäº§ç¯å¢ƒï¼Ÿ", ok: 'YES, destroy'
                  }
                  def approve = params.AUTO_APPROVE.toBoolean() ? "-auto-approve" : ""
                  sh """
                    terraform init -backend-config=backend.hcl -reconfigure
                    terraform destroy ${approve} -var-file=${params.ENV}.tfvars
                  """
                  
                  // å¦‚æœæ˜¯ PRï¼Œè¯„è®ºé”€æ¯ç»“æœ
                  if (env.CHANGE_ID) {
                    commentDestroyToPR()
                  }
                  
                  echo "âœ… Destroy å®Œæˆï¼èµ„æºå·²åˆ é™¤"
                }
              }
            }
          }
        }
      }
    }
  }

  post {
    always {
      // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      sh 'rm -f infra/envs/*/tfplan infra/envs/*/plan.txt infra/envs/*/plan.json || true'
    }
    success {
      echo "ğŸ‰ Pipeline æ‰§è¡ŒæˆåŠŸï¼"
    }
    failure {
      echo "âŒ Pipeline æ‰§è¡Œå¤±è´¥ï¼"
      // å¦‚æœæ˜¯ PRï¼Œè¯„è®ºå¤±è´¥ä¿¡æ¯
      if (env.CHANGE_ID) {
        commentFailureToPR()
      }
    }
  }
}

// è¯„è®º Plan ç»“æœåˆ° PR
def commentPlanToPR() {
  try {
    def planContent = readFile("infra/envs/${params.ENV}/plan.txt").trim()
    def comment = """
## ğŸ” Terraform Plan - ${params.ENV.toUpperCase()} Environment

**æ„å»ºä¿¡æ¯ï¼š**
- ç¯å¢ƒ: \`${params.ENV}\`
- åˆ†æ”¯: \`${env.BRANCH_NAME ?: 'main'}\`
- æäº¤: \`${env.GIT_COMMIT?.take(7) ?: 'unknown'}\`
- æ„å»º: [#${env.BUILD_NUMBER}](${env.BUILD_URL})

**è®¡åˆ’æ‘˜è¦ï¼š**
\`\`\`
${planContent}
\`\`\`

**ä¸‹ä¸€æ­¥ï¼š**
- âœ… å¦‚æœè®¡åˆ’æ­£ç¡®ï¼Œè¯·åˆå¹¶æ­¤ PR
- ğŸ”„ åˆå¹¶åå°†è‡ªåŠ¨è§¦å‘ \`terraform apply\`
- âŒ å¦‚æœ‰é—®é¢˜ï¼Œè¯·ä¿®æ”¹ä»£ç åé‡æ–°æäº¤

---
*æ­¤è¯„è®ºç”± Jenkins è‡ªåŠ¨ç”Ÿæˆ*
"""
    
    postCommentToPR(comment)
    echo "ğŸ“ Plan ç»“æœå·²è¯„è®ºåˆ° PR #${env.CHANGE_ID}"
  } catch (Exception e) {
    echo "âš ï¸ è¯„è®º PR å¤±è´¥: ${e.getMessage()}"
  }
}

// è¯„è®º Apply ç»“æœåˆ° PR
def commentApplyToPR() {
  try {
    def comment = """
## âœ… Terraform Apply å®Œæˆ - ${params.ENV.toUpperCase()} Environment

**æ„å»ºä¿¡æ¯ï¼š**
- ç¯å¢ƒ: \`${params.ENV}\`
- åˆ†æ”¯: \`${env.BRANCH_NAME ?: 'main'}\`
- æäº¤: \`${env.GIT_COMMIT?.take(7) ?: 'unknown'}\`
- æ„å»º: [#${env.BUILD_NUMBER}](${env.BUILD_URL})

**æ‰§è¡Œç»“æœï¼š**
ğŸ‰ èµ„æºå·²æˆåŠŸåˆ›å»º/æ›´æ–°åˆ° \`${params.ENV}\` ç¯å¢ƒ

---
*æ­¤è¯„è®ºç”± Jenkins è‡ªåŠ¨ç”Ÿæˆ*
"""
    
    postCommentToPR(comment)
    echo "ğŸ“ Apply ç»“æœå·²è¯„è®ºåˆ° PR #${env.CHANGE_ID}"
  } catch (Exception e) {
    echo "âš ï¸ è¯„è®º PR å¤±è´¥: ${e.getMessage()}"
  }
}

// è¯„è®º Destroy ç»“æœåˆ° PR
def commentDestroyToPR() {
  try {
    def comment = """
## âš ï¸ Terraform Destroy å®Œæˆ - ${params.ENV.toUpperCase()} Environment

**æ„å»ºä¿¡æ¯ï¼š**
- ç¯å¢ƒ: \`${params.ENV}\`
- åˆ†æ”¯: \`${env.BRANCH_NAME ?: 'main'}\`
- æäº¤: \`${env.GIT_COMMIT?.take(7) ?: 'unknown'}\`
- æ„å»º: [#${env.BUILD_NUMBER}](${env.BUILD_URL})

**æ‰§è¡Œç»“æœï¼š**
ğŸ—‘ï¸ èµ„æºå·²ä» \`${params.ENV}\` ç¯å¢ƒåˆ é™¤

---
*æ­¤è¯„è®ºç”± Jenkins è‡ªåŠ¨ç”Ÿæˆ*
"""
    
    postCommentToPR(comment)
    echo "ğŸ“ Destroy ç»“æœå·²è¯„è®ºåˆ° PR #${env.CHANGE_ID}"
  } catch (Exception e) {
    echo "âš ï¸ è¯„è®º PR å¤±è´¥: ${e.getMessage()}"
  }
}

// è¯„è®ºå¤±è´¥ä¿¡æ¯åˆ° PR
def commentFailureToPR() {
  try {
    def comment = """
## âŒ Terraform Pipeline å¤±è´¥ - ${params.ENV.toUpperCase()} Environment

**æ„å»ºä¿¡æ¯ï¼š**
- ç¯å¢ƒ: \`${params.ENV}\`
- æ“ä½œ: \`${params.ACTION}\`
- åˆ†æ”¯: \`${env.BRANCH_NAME ?: 'main'}\`
- æäº¤: \`${env.GIT_COMMIT?.take(7) ?: 'unknown'}\`
- æ„å»º: [#${env.BUILD_NUMBER}](${env.BUILD_URL})

**é”™è¯¯ä¿¡æ¯ï¼š**
è¯·æŸ¥çœ‹ [æ„å»ºæ—¥å¿—](${env.BUILD_URL}) è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚

**å»ºè®®ï¼š**
- ğŸ” æ£€æŸ¥ Terraform é…ç½®è¯­æ³•
- ğŸ”§ ä¿®å¤é”™è¯¯åé‡æ–°æäº¤
- ğŸ“ å¦‚éœ€è¦å¸®åŠ©ï¼Œè¯·è”ç³» DevOps å›¢é˜Ÿ

---
*æ­¤è¯„è®ºç”± Jenkins è‡ªåŠ¨ç”Ÿæˆ*
"""
    
    postCommentToPR(comment)
    echo "ğŸ“ å¤±è´¥ä¿¡æ¯å·²è¯„è®ºåˆ° PR #${env.CHANGE_ID}"
  } catch (Exception e) {
    echo "âš ï¸ è¯„è®º PR å¤±è´¥: ${e.getMessage()}"
  }
}

// å‘é€è¯„è®ºåˆ° GitHub PR
def postCommentToPR(String comment) {
  withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
    def apiUrl = "https://api.github.com/repos/${env.GITHUB_REPO}/issues/${env.CHANGE_ID}/comments"
    def payload = [
      body: comment
    ]
    
    def response = httpRequest(
      httpMode: 'POST',
      url: apiUrl,
      headers: [
        'Authorization': "token ${GITHUB_TOKEN}",
        'Content-Type': 'application/json'
      ],
      requestBody: groovy.json.JsonBuilder(payload).toString()
    )
    
    if (response.status == 201) {
      echo "âœ… æˆåŠŸè¯„è®ºåˆ° PR #${env.CHANGE_ID}"
    } else {
      echo "âš ï¸ è¯„è®º PR å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}"
    }
  }
}

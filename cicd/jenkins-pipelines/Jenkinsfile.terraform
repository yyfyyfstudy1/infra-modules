pipeline {
  agent any

  parameters {
    choice(name: 'ENV', choices: ['dev', 'test', 'prod'], description: 'Target environment')
    choice(name: 'ACTION', choices: ['plan', 'apply', 'destroy'], description: 'Terraform action')
    booleanParam(name: 'AUTO_APPROVE', defaultValue: true, description: 'Auto-approve (prod å»ºè®®æ‰‹åŠ¨)')
  }

  environment {
    TF_IN_AUTOMATION = '1'
    AWS_REGION       = 'ap-southeast-2'
  }

  options {
    timestamps()
    buildDiscarder(logRotator(numToKeepStr: '10'))
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build Info') {
      steps {
        script {
          echo "ğŸš€ Jenkins Pipeline å¯åŠ¨"
          echo "ğŸ“‹ æ„å»ºå‚æ•°ï¼š"
          echo "   - ç¯å¢ƒ: ${params.ENV}"
          echo "   - æ“ä½œ: ${params.ACTION}"
          echo "   - è‡ªåŠ¨æ‰¹å‡†: ${params.AUTO_APPROVE}"
          echo ""
          echo "ğŸ’¡ æç¤ºï¼š"
          if (params.ACTION == 'plan') {
            echo "   - å½“å‰æ‰§è¡Œ PLANï¼ŒåªæŸ¥çœ‹å˜æ›´ï¼Œä¸ä¼šå®é™…åˆ›å»ºèµ„æº"
            echo "   - å¦‚éœ€åˆ›å»ºèµ„æºï¼Œè¯·é‡æ–°æ„å»ºå¹¶é€‰æ‹© ACTION=apply"
          } else if (params.ACTION == 'apply') {
            echo "   - å½“å‰æ‰§è¡Œ APPLYï¼Œå°†å®é™…åˆ›å»º/ä¿®æ”¹èµ„æº"
            echo "   - è¯·ç¡®è®¤è¿™æ˜¯ä½ æƒ³è¦çš„æ“ä½œ"
          } else if (params.ACTION == 'destroy') {
            echo "   - âš ï¸  å½“å‰æ‰§è¡Œ DESTROYï¼Œå°†åˆ é™¤èµ„æº"
            echo "   - è¯·ç¡®è®¤è¿™æ˜¯ä½ æƒ³è¦çš„æ“ä½œ"
          }
        }
      }
    }

    stage('Terraform Operations') {
      steps {
        script {
          def credId = (params.ENV == 'dev')  ? 'aws-role-dev'  :
                       (params.ENV == 'test') ? 'aws-role-test' :
                                                 'aws-role-prod'

          withCredentials([string(credentialsId: credId, variable: 'ROLE_ARN')]) {
            withAWS(region: AWS_REGION, role: ROLE_ARN, roleSessionName: "jenkins-${params.ENV}") {

              dir("infra/envs/${params.ENV}") {
                if (params.ACTION == 'plan') {
                  echo "ğŸ” æ‰§è¡Œ Terraform Plan..."
                  sh """
                    terraform init -backend-config=backend.hcl -reconfigure
                    terraform plan -var-file=${params.ENV}.tfvars -out=tfplan
                  """
                  echo "âœ… Plan å®Œæˆï¼å¦‚éœ€åº”ç”¨å˜æ›´ï¼Œè¯·é‡æ–°æ„å»ºå¹¶é€‰æ‹© ACTION=apply"
                } else if (params.ACTION == 'apply') {
                  echo "ğŸš€ æ‰§è¡Œ Terraform Apply..."
                  sh """
                    terraform init -backend-config=backend.hcl -reconfigure
                    terraform plan -var-file=${params.ENV}.tfvars -out=tfplan
                  """
                  if (!params.AUTO_APPROVE.toBoolean()) {
                    input message: "ç¡®è®¤ Apply åˆ° ${params.ENV} ?", ok: 'Apply'
                  }
                  sh "terraform apply -auto-approve tfplan"
                  echo "âœ… Apply å®Œæˆï¼èµ„æºå·²åˆ›å»º/æ›´æ–°"
                } else if (params.ACTION == 'destroy') {
                  echo "âš ï¸  æ‰§è¡Œ Terraform Destroy..."
                  if (params.ENV == 'prod') {
                    input message: "ç¡®è®¤ DESTROY ç”Ÿäº§ç¯å¢ƒï¼Ÿ", ok: 'YES, destroy'
                  }
                  def approve = params.AUTO_APPROVE.toBoolean() ? "-auto-approve" : ""
                  sh """
                    terraform init -backend-config=backend.hcl -reconfigure
                    terraform destroy ${approve} -var-file=${params.ENV}.tfvars
                  """
                  echo "âœ… Destroy å®Œæˆï¼èµ„æºå·²åˆ é™¤"
                }
              }
            }
          }
        }
      }
    }
  }
}
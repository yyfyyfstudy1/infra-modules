pipeline {
  agent any

  parameters {
    choice(name: 'ENV', choices: ['test', 'prod'], description: 'ç›®æ ‡ç¯å¢ƒ')
    string(name: 'SHA', defaultValue: '', description: 'è¦å‘å¸ƒçš„ commit/tagï¼ˆå¯é€‰ï¼‰')
    booleanParam(name: 'AUTO_APPROVE', defaultValue: true, description: 'Auto-approve applyï¼ˆprod å»ºè®®äººå·¥ç¡®è®¤ï¼‰')
  }

  environment {
    TF_IN_AUTOMATION = '1'
    AWS_REGION       = 'ap-southeast-2'
  }

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        script {
          if (params.SHA?.trim()) {
            sh "git fetch --all --tags --prune"
            sh "git checkout ${params.SHA}"
            echo "ğŸ”– å·²æ£€å‡ºæŒ‡å®šç‰ˆæœ¬: ${params.SHA}"
          } else {
            echo "ğŸ”– æœªæŒ‡å®š SHAï¼Œä½¿ç”¨é»˜è®¤ SCM ç‰ˆæœ¬"
          }
        }
      }
    }

    stage('Promote Plan/Apply') {
      steps {
        script {
          def credId = (params.ENV == 'test') ? 'aws-role-test' : 'aws-role-prod'
          withCredentials([string(credentialsId: credId, variable: 'ROLE_ARN')]) {
            withAWS(region: AWS_REGION, role: ROLE_ARN, roleSessionName: "jenkins-${params.ENV}") {
              dir("infra/app") {
                sh """
                  terraform init -backend-config=backend.hcl -reconfigure
                  terraform workspace select ${params.ENV} || terraform workspace new ${params.ENV}
                  terraform plan -var-file=envs/${params.ENV}.tfvars -out=tfplan
                """
                if (!params.AUTO_APPROVE.toBoolean() && params.ENV == 'prod') {
                  input message: "ç¡®è®¤ Apply åˆ° ${params.ENV}ï¼Ÿ", ok: 'Apply'
                }
                sh "terraform apply -auto-approve tfplan"
              }
            }
          }
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: '**/tfplan', allowEmptyArchive: true
    }
    success {
      echo "âœ… Promote åˆ° ${params.ENV} æˆåŠŸ"
    }
    failure {
      echo "âŒ Promote å¤±è´¥"
    }
  }
}

